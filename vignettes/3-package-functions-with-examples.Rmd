---
title: "3-Package Functions with Examples"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{3-package-functions-with-examples}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(VulnerabilityScoreCalibration)
```

<!-- WARNING - This vignette is generated by {fusen} from /dev/package_functions.Rmd: do not edit by hand -->

# data

## Built-in Data

This includes the skeleton to build the 2 questionnaires in different languages


## Demo Data

The demo data includes the list of indicators/criteria in different langues


```{r}

readxl::read_excel( system.file("data-demo/indicator_criteria.xlsx", package = "VulnerabilityScoreCalibration"),
                            sheet = "indicator")  |>
  dplyr::filter( language == "English (en)") |>
  dplyr::select( dimension, indicator, indicator_hint)

```

The following dataset has been anonymized from one of the field implementation.


```{r}
kobodata <-  system.file("data-demo/quadra_data.xlsx", package = "VulnerabilityScoreCalibration")
koboform <-  system.file("data-demo/quadra_form.xlsx", package = "VulnerabilityScoreCalibration")


```

# Quadratic Voting

## quadratic_prepare

```{r example-quadratic_prepare}

indicator <-  system.file("data-demo/indicator_criteria.xlsx", package = "VulnerabilityScoreCalibration")
quadratic_prepare()
```

## mod_quadratic_prepare

```{r example-mod_quadratic_prepare}
#mod_quadratic_prepare()
```

## quadratic_review

```{r example-quadratic_review}

# kobodata <- here::here("", "quadra_data.xlsx")
# koboform <- here::here("", "survey_quadraticvoting_CBI_Indicators.xlsx")

kobodata <-  system.file("data-demo/quadra_data.xlsx", package = "VulnerabilityScoreCalibration")
koboform <-  system.file("data-demo/quadra_form.xlsx", package = "VulnerabilityScoreCalibration")
 
## Run the process
result <- quadratic_review(kobodata, koboform)

## Review output
result[["topic_prioritisation"]]

result[["vote_dispersion"]]

result[["individual_prioritisation"]]

```

## mod_quadratic_review

Below is a golem module to make the function available within the shiny App


```{r example-mod_quadratic_review}
#mod_quadratic_review()
```

## quadratic_report

```{r example-quadratic_report}

## Example -> the report will be saved in the same folder...
# quadratic_report(data = "data.xlsx",
#                  form = "form.xlsx",
#                  folder = "data-raw") 
```

# Conjoint Analysis

## conjoint_prepare

```{r example-conjoint_prepare}


# indicator <-  system.file("data-demo/indicator_criteria.xlsx", package = "VulnerabilityScoreCalibration")
# opts <- read_excel("cja_opts_SAL.xlsx")
# 
# conjoint_prepare( opts = opts, 
#                   language = "Spanish (es)",
#                   form_title = "Actividad #2: CalificaciÃ³n de perfiles de vulnerabilidad - El Salvador, 23 de marzo, 2023",
#                   id_string = "vulnerability_rating",
#                   outdir = "", 
#                   outfile = "form.xlsx" )
```

## mod_conjoint_prepare

```{r example-mod_conjoint_prepare}
#mod_conjoint_prepare()
```

## conjoint_review

```{r example-conjoint_review}

kobodata <-  system.file("data-demo/conjoint_data.xlsx", package = "VulnerabilityScoreCalibration")
koboform <-  system.file("data-demo/conjoint_form.xlsx", package = "VulnerabilityScoreCalibration") 

cj <- conjoint_review(kobodata, koboform)

cj[["data_quality"]]
```

## conjoint_plot_point 

```{r example-conjoint_plot_point}

kobodata <-  system.file("data-demo/conjoint_data.xlsx", package = "VulnerabilityScoreCalibration")
koboform <-  system.file("data-demo/conjoint_form.xlsx", package = "VulnerabilityScoreCalibration") 

cj <- conjoint_review(kobodata, koboform)
 
conjoint_plot_point( as.data.frame(cj[["cjdata"]][1,][["margins"]])) + 
  ggplot2::labs( subtitle = "Margins)")

conjoint_plot_point( as.data.frame(cj[["cjdata"]][1,][["amces"]])) + 
  ggplot2::labs( subtitle = "Average Marginal Component Effects (AMCEs)")

conjoint_plot_point( as.data.frame(cj[["cjdata"]][1,][["importance"]])) + 
  ggplot2::labs( subtitle = "Importance")
```

## conjoint_plot_bar - Average Marginal Component Effects (AMCEs)

```{r example-conjoint_plot_bar}

kobodata <-  system.file("data-demo/conjoint_data.xlsx", package = "VulnerabilityScoreCalibration")
koboform <-  system.file("data-demo/conjoint_form.xlsx", package = "VulnerabilityScoreCalibration") 

cj <- conjoint_review(kobodata, koboform)
 
## Plot AMCES as bar for dimension 2
conjoint_plot_bar( as.data.frame(cj[["cjdata"]][2,][["amces"]])) + 
  ggplot2::labs( subtitle = "Average Marginal Component Effects (AMCEs)")

## Plot importance as bar for dimension 2
conjoint_plot_bar( as.data.frame(cj[["cjdata"]][2,][["importance"]])) + 
  ggplot2::labs( subtitle = "Importance")
```

## conjoint_walk - Summary by dimension

```{r example-conjoint_walk}
kobodata <-  system.file("data-demo/conjoint_data.xlsx", package = "VulnerabilityScoreCalibration")
koboform <-  system.file("data-demo/conjoint_form.xlsx", package = "VulnerabilityScoreCalibration") 

cj <- conjoint_review(kobodata, koboform) 
cjdata <- cj[["cjdata"]]
## Get a summary of all dimensions
purrr::pwalk(cjdata, conjoint_walk)

## Save a csv extract of the weights
# purrr::walk2(cjdata$dim, cjdata$amces, ~write_csv(.y, fs::path(.x, ext = "csv")))

all <- purrr::walk2(cjdata$amces,  ~cbind())

all <-purrr::pwalk(cjdata$amces, rbind)
all2 <- bind_rows(cjdata$amces, .id = "column_label")



```

## mod_conjoint_review

```{r example-mod_conjoint_review}
#mod_conjoint_review()
```

# mod_home

```{r example-mod_home}
#mod_home()
```

