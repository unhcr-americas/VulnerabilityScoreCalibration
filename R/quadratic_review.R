# WARNING - Generated by {fusen} from dev/function_documentation.Rmd: do not edit by hand

#' quadratic_review
#' 
#' Explore the results from a quadratic voting consultations. 
#'  1. What are the prioritized Topics?
#'  2. How dispersed participants votes are? 
#'  3. Who is expecting or pushing back... on what? 
#'  
#' @param kobodata path to data collected through kobotoolbox
#' @param koboform form used to collected through kobotoolbox quadratic survey
#' 
#' 
#' @importFrom ggridges geom_density_ridges
#' @importFrom unhcrthemes theme_unhcr
#' @importFrom readxl read_excel
#' @importFrom dplyr arrange select rename  
#'                group_by first
#'                left_join filter mutate desc
#' @importFrom forcats fct_reorder	
#' @importFrom tidyselect starts_with
#' @importFrom stats sd reorder
#' @import ggplot2
#' @return list with data and standard plots
#' 
#' @export
#' @examples
#'
#' # kobodata <- here::here("", "quadra_data.xlsx")
#' # koboform <- here::here("", "survey_quadraticvoting_CBI_Indicators.xlsx")
#'
#' kobodata <-  system.file("data-demo/quadra_data.xlsx", package = "VulnerabilityScoreCalibration")
#' koboform <-  system.file("data-demo/quadra_form.xlsx", package = "VulnerabilityScoreCalibration")
#'  
#' ## Run the process
#' result <- quadratic_review(kobodata, koboform)
#'
#' ## Review output
#' result[["topic_prioritisation"]]
#'
#' result[["vote_dispersion"]]
#'
#' result[["individual_prioritisation"]]
#'
quadratic_review <- function(kobodata, koboform){
  
  ## load data
  data_ind <- readxl::read_excel( kobodata,
                            sheet = 1)
  data_positions <- readxl::read_excel(kobodata,
                       sheet = "positions")
  
  #names(data_positions)
  
  ## load info from the form
  positions <- readxl::read_excel(koboform,
                       sheet = "positions") |>
    # names(positions)
    dplyr::select(topic, name) |>
    dplyr::rename(groups.positions.pos_name = name)
  
  # choices <- readxl::read_excel(koboform,
  #                      sheet = "choices") |>
  #   ## Rename and use what ever label set is coming first 
  #   dplyr::rename(label = dplyr::first(tidyselect::starts_with("label")) )
  
  
  ## Check who did not reply
  #part1 <- part |>
  # dplyr::left_join(ind, by = c( "email" )) |>
  # dplyr::filter(is.na(start))
  
  ## Check matching
  data_ind2 <- data_ind
  
  data11_positions <- data_positions |>
    dplyr::left_join(positions) |>
    ## Add Participant info
    dplyr::left_join(data_ind2, by = c("_submission__uuid" = "_uuid")) |>
    
    dplyr::filter(!(is.na(groups.positions.votes)))
  
  data1_positions <- data11_positions |>
    dplyr::select(
      email,
      topic,
      groups.positions.pos_name,
      groups.positions.pos_text,
      groups.positions.votes,
      groups.positions.vote_cost
    ) |>
    dplyr::mutate(
      position = paste0(groups.positions.pos_text),
      groups.positions.votes = as.numeric(groups.positions.votes),
      groups.positions.vote_cost = as.numeric(groups.positions.vote_cost)
    ) |>
    dplyr::group_by(position,
             groups.positions.pos_name,
             groups.positions.pos_text) |>
    dplyr::summarise(
      cnt = dplyr::n(),
      vote = sum(groups.positions.votes),
      votemean = mean(groups.positions.votes),
      votesd = stats::sd(groups.positions.votes),
      votecost = sum (groups.positions.vote_cost)
    )  |>
    dplyr::arrange(dplyr::desc(vote))
  
  ## Reshape the data to merge votes
  df <- data_positions |>
    ## Add theme
    dplyr::left_join(positions) |>
    ## Add Participant info
    dplyr::left_join(data_ind2, by = c("_submission__uuid" = "_uuid")) |>
    dplyr::filter(!(is.na(groups.positions.votes))) |>
    dplyr::filter(!(is.na(email))) |>
    dplyr::select(
      email,
      topic,
      groups.positions.pos_name,
      groups.positions.pos_text,
      groups.positions.votes,
      groups.positions.vote_cost
    ) |>
    dplyr::mutate(
      position = paste0(groups.positions.pos_text),
      posit = paste0(topic, "-", groups.positions.pos_name),
      groups.positions.votes = as.numeric(groups.positions.votes),
      groups.positions.vote_cost = as.numeric(groups.positions.vote_cost)
    ) |>
    dplyr::mutate(
      groups.positions.pos_text = forcats::fct_reorder(.f = groups.positions.pos_text,
                                              .x = groups.positions.vote_cost,
                                              .fun = mean)
    ) |>
    dplyr::mutate(position = forcats::fct_reorder(.f = position,
                                         .x = groups.positions.vote_cost,
                                         .fun = mean)) |>
    dplyr::mutate(posit  = forcats::fct_reorder(.f = posit ,
                                       .x = groups.positions.vote_cost,
                                       .fun = mean))
  
  
  ## What are the prioritized Topics?
  p <- ggplot(data1_positions) +
    aes(x = stats::reorder(position, vote),
        fill = votesd,
        weight = vote) +
    geom_bar() +
    #  scale_fill_viridis_c(option = "inferno", direction = 1) +
    scale_fill_distiller(palette = "Oranges", direction = -1) +
    coord_flip() +
    unhcrthemes::theme_unhcr(font_size = 14)  +
    theme(
      panel.grid.major.x  = element_line(color = "#cbcbcb"),
      panel.grid.major.y  = element_blank(),
      panel.grid.minor = element_blank()
      # legend.position= "none"
    ) +
    labs(
      title = "Validation of indicators to be scored in the Eligibility Scorecard",
      subtitle = "In addition to the total number of votes, we can also see the level of agreement by color: the darker the vote, the more consensus...",
      x = "",
      y = "",
      caption = paste0(
        "Data collected through quadratic voting - # of participants ",
        nrow(data_ind |> dplyr::filter(!(is.na(   email   ))))
      )
    )
  
  ## How dispersed participants votes are?
  p2 <- ggplot(df,
               aes(x = groups.positions.votes,
                   y = position)) +
    ggridges::geom_density_ridges(fill = "#00AFBB",
                        rel_min_height = 0.01,
                        alpha = 0.7) +
    unhcrthemes::theme_unhcr(font_size = 14)  +
    theme(
      panel.grid.major.x  = element_line(color = "#cbcbcb"),
      panel.grid.major.y  = element_blank(),
      panel.grid.minor = element_blank()
    ) +
    labs(
      title = "Dispersion of votes on indicators to prioritize",
      x = "",
      y = "",
      caption = paste0(
        "Data collected through a quadratic voting survey. # of participants to the consultation is    ",
        nrow(data_ind |> dplyr::filter(!(is.na(  email  ))))
      )
    )
  
  ## Who is expecting (or pushing back...) on what?
  p3 <- ggplot(df) +
    aes(x = stats::reorder(posit, groups.positions.votes),
        y = groups.positions.votes) +
    geom_bar(stat = "identity" ,
                   fill = "#0072BC") +
    facet_wrap(~ email, nrow = 3) +
    coord_flip() +
    unhcrthemes::theme_unhcr(font_size = 12,
                             rel_small = 6/9,
                             rel_tiny = 6/9,
                             rel_large = 12/8)  +
    theme(
      panel.grid.major.x  = element_line(color = "#cbcbcb"),
      panel.grid.major.y  = element_line(color = "#e1e1e1"),
      panel.grid.minor = element_blank(),
      legend.position = "none",
      panel.spacing = unit(0.1, "lines"),
      strip.background = element_rect(
        color = "black",
        size = 1.5,
        linetype = "solid"
      )
    ) +
    labs(
      title = "Individual Prioritisation of indicators to score",
      x = "",
      y = "",
      caption = paste0(
        "Data collected through a quadratic voting survey. # of participants to the consultation is  ",
        nrow(data_ind |> dplyr::filter(!(is.na(  email))))
      )
    )
  
  #p3
  results <- list(df =df,
                  topic_prioritisation = p,
                  vote_dispersion = p2,
                  individual_prioritisation = p3)
  return(results)
    
}
