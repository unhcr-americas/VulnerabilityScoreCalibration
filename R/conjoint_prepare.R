# WARNING - Generated by {fusen} from /dev/package_functions.Rmd: do not edit by hand

#' conjoint_prepare
#' 
#' Generate an xlsform used to perform consultation for conjoint analysis.
#' 
#' The options that will be compared are the different levels of the section 
#' of indicators that should have been filtered through the quadratic voting 
#' stage.
#' 
#' One level can actually match multiple response options from the screening 
#' questionnaire 
#' 
#' @param opts a dataframe containing the options to compare
#' @param language
#' @param form_title  Actividad #2: Calificación de perfiles de vulnerabilidad 
#' @param id_string vulnerability_rating
#' @param outdir   
#' @param outfile
#' 
#' @return a file in xlsform format
#' 
#' @importFrom readr read_csv
#' @importFrom writexl write_xlsx
#' @importFrom dplyr group_by group_map tibble
#' @importFrom conjoint caFactorialDesign
#' @importFrom tidyr expand_grid
#' @importFrom purrr map imap pmap_dfr
#' @importFrom rlang list2 set_names
#' @export
#' @examples
#' 
#' 
#' # indicator <-  system.file("data-demo/indicator_criteria.xlsx", package = "VulnerabilityScoreCalibration")
#' # opts <- read_excel("cja_opts_SAL.xlsx")
#' # 
#' # conjoint_prepare( opts = opts, 
#' #                   language = "Spanish (es)",
#' #                   form_title = "Actividad #2: Calificación de perfiles de vulnerabilidad - El Salvador, 23 de marzo, 2023",
#' #                   id_string = "vulnerability_rating",
#' #                   outdir = "", 
#' #                   outfile = "form.xlsx" )
conjoint_prepare <- function(opts,language, form_title, id_string , outdir , outfile ){

  ## is in package
#survey <- readr::read_csv("conjointSurvey.csv")
#choices <- read_csv("conjointChoices.csv")
  
## Build the profiles using a factorial design  
profiles <-  opts |>
  nest(data = -dim) |>
  (\(x) rlang::set_names(x$data, x$dim))() |>
  purrr::map( ~ dplyr::group_map( dplyr::group_by(., measure),
                   ~ rlang::list2(!!.y$measure := .x$level)) |>
         purrr::flatten() |>
         (\(x) tidyr::expand_grid(!!!x))()) |>
  purrr::map( ~ conjoint::caFactorialDesign(., type = "fractional")) |>
  purrr::imap( ~ purrr::pmap_dfr(
    .,
    ~ dplyr::tibble(
      type = "select_one scale",
      appearance = "horizontal-compact",
      required = TRUE,
      label = str_c(..., sep = "\n")
    )
  ) |>
    dplyr::mutate(name = str_c(.y, row_number(), sep = "_"), .before = 1)) |>
  purrr::imap( ~ bind_rows(
    list(type = "begin_group", name = .y, label = .y),
    .x,
    list(type = "end_group")
  )) |>
  dplyr::bind_rows()

## build the survey part
survey <-  dplyr::bind_rows(
    survey |> 
      slice_head(n = detect_index(survey$name,
                                  ~ replace_na(. == "p", FALSE))),
    profiles,
    survey |> slice_tail(n = -detect_index(survey$name, 
                                           ~ replace_na(. == "p", FALSE)))
  )

## Define the settings
settings <-  dplyr::tibble(form_title = form_title,
         id_string = id_string,
         style = "theme-grid")

writexl::write_xlsx(
  list(
    survey = survey,
    choices = choices,
    settings = settings
  ),
  path = here::here(outdir, oufile),
  format_headers = FALSE
)
    
}
